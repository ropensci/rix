<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Evaluate function in R or shell command via nix-shell environment — with_nix • rix</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Evaluate function in R or shell command via nix-shell environment — with_nix"><meta name="description" content="This function needs an installation of Nix. with_nix() has two effects
to run code in isolated and reproducible environments.
Evaluate a function in R or a shell command via the nix-shell
environment (Nix expression for custom software libraries; involving pinned
versions of R and R packages via Nixpkgs)
If no error, return the result object of expr in with_nix() into the
current R session.

"><meta property="og:description" content="This function needs an installation of Nix. with_nix() has two effects
to run code in isolated and reproducible environments.
Evaluate a function in R or a shell command via the nix-shell
environment (Nix expression for custom software libraries; involving pinned
versions of R and R packages via Nixpkgs)
If no error, return the result object of expr in with_nix() into the
current R session.

"><meta property="og:image" content="https://b-rodrigues.github.io/rix/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rix</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/a-getting-started.html">a - Getting started</a></li>
    <li><a class="dropdown-item" href="../articles/b1-setting-up-and-using-rix-on-linux-and-windows.html">b1 - Setting up and using rix on Linux and Windows</a></li>
    <li><a class="dropdown-item" href="../articles/b2-setting-up-and-using-rix-on-macos.html">b2 - Setting up and using rix on macOS</a></li>
    <li><a class="dropdown-item" href="../articles/c-using-rix-to-build-project-specific-environments.html">c - Using rix to build project specific environments</a></li>
    <li><a class="dropdown-item" href="../articles/d1-installing-r-packages-in-a-nix-environment.html">d1 - Installing R packages in a Nix environment</a></li>
    <li><a class="dropdown-item" href="../articles/d2-installing-system-tools-and-texlive-packages-in-a-nix-environment.html">d2 - Installing system tools and TexLive packages in a Nix environment</a></li>
    <li><a class="dropdown-item" href="../articles/e-interactive-use.html">e - Interactive use</a></li>
    <li><a class="dropdown-item" href="../articles/z-advanced-topic-building-an-environment-for-literate-programming.html">z - Advanced topic: Building an environment for literate programming</a></li>
    <li><a class="dropdown-item" href="../articles/z-advanced-topic-handling-packages-with-remote-dependencies.html">z - Advanced topic: Handling packages with remote dependencies</a></li>
    <li><a class="dropdown-item" href="../articles/z-advanced-topic-reproducible-analytical-pipelines-with-nix.html">z - Advanced topic: Reproducible Analytical Pipelines with Nix</a></li>
    <li><a class="dropdown-item" href="../articles/z-advanced-topic-running-r-or-shell-code-in-nix-from-r.html">z - Advanced topic: Running R or Shell Code in Nix from R</a></li>
    <li><a class="dropdown-item" href="../articles/z-advanced-topic-using-nix-inside-docker.html">z - Advanced topic: Using Nix inside Docker</a></li>
    <li><a class="dropdown-item" href="../articles/z-binary_cache.html">z - Advanced topic: Rolling out your own binary cache</a></li>
    <li><a class="dropdown-item" href="../articles/z-bleeding_edge.html">z - Advanced topic: Understanding the rPackages set release cycle and using bleeding edge packages</a></li>
    <li><a class="dropdown-item" href="../articles/z-contributing_to_nixpkgs.html">z - Advanced topic: Contributing to nixpkgs</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/b-rodrigues/rix/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Evaluate function in R or shell command via <code>nix-shell</code> environment</h1>
      <small class="dont-index">Source: <a href="https://github.com/b-rodrigues/rix/blob/master/R/with_nix.R" class="external-link"><code>R/with_nix.R</code></a></small>
      <div class="d-none name"><code>with_nix.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function needs an installation of Nix. <code>with_nix()</code> has two effects
to run code in isolated and reproducible environments.</p><ol><li><p>Evaluate a function in R or a shell command via the <code>nix-shell</code>
environment (Nix expression for custom software libraries; involving pinned
versions of R and R packages via Nixpkgs)</p></li>
<li><p>If no error, return the result object of <code>expr</code> in <code>with_nix()</code> into the
current R session.</p></li>
</ol></div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">with_nix</span><span class="op">(</span></span>
<span>  <span class="va">expr</span>,</span>
<span>  program <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"R"</span>, <span class="st">"shell"</span><span class="op">)</span>,</span>
<span>  project_path <span class="op">=</span> <span class="st">"."</span>,</span>
<span>  message_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"simple"</span>, <span class="st">"quiet"</span>, <span class="st">"verbose"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-expr">expr<a class="anchor" aria-label="anchor" href="#arg-expr"></a></dt>
<dd><p>Single R function or call, or character vector of length one with
shell command and possibly options (flags) of the command to be invoked.
For <code>program = R</code>, you can both use a named or an anonymous function.
The function provided in <code>expr</code> should not evaluate when you pass arguments,
hence you need to wrap your function call like
<code>function() your_fun(arg_a = "a", arg_b = "b")</code>, to avoid evaluation and make
sure <code>expr</code> is a function (see details and examples).</p></dd>


<dt id="arg-program">program<a class="anchor" aria-label="anchor" href="#arg-program"></a></dt>
<dd><p>String stating where to evaluate the expression. Either <code>"R"</code>,
the default, or <code>"shell"</code>. <code>where = "R"</code> will evaluate the expression via
<code>RScript</code> and <code>where = "shell"</code> will run the system command in <code>nix-shell</code>.</p></dd>


<dt id="arg-project-path">project_path<a class="anchor" aria-label="anchor" href="#arg-project-path"></a></dt>
<dd><p>Path to the folder where the <code>default.nix</code> file resides.
The default is <code>"."</code>, which is the working directory in the current R
session. This approach also useful when you have different subfolders
with separate software environments defined in different <code>default.nix</code> files.</p></dd>


<dt id="arg-message-type">message_type<a class="anchor" aria-label="anchor" href="#arg-message-type"></a></dt>
<dd><p>String how detailed output is. Currently, there is
either <code>"simple"</code> (default), <code>"quiet</code> or <code>"verbose"</code>, which shows the script
that runs via <code>nix-shell</code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>

<ul><li><p>if <code>program = "R"</code>, R object returned by function given in <code>expr</code>
when evaluated via the R environment in <code>nix-shell</code> defined by Nix
expression.</p></li>
<li><p>if <code>program = "shell"</code>, list with the following elements:</p><ul><li><p><code>status</code>: exit code</p></li>
<li><p><code>stdout</code>: character vector with standard output</p></li>
<li><p><code>stderr</code>: character vector with standard error
of <code>expr</code> command sent to a command line interface provided by a Nix package.</p></li>
</ul></li>
</ul></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p><code>with_nix()</code> gives you the power of evaluating a main function <code>expr</code>
and its function call stack that are defined in the current R session
in an encapsulated nix-R session defined by Nix expression (<code>default.nix</code>),
which is located in at a distinct project path (<code>project_path</code>).</p>
<p><code>with_nix()</code> is very convenient because it gives direct code feedback in
read-eval-print-loop style, which gives a direct interface to the very
reproducible infrastructure-as-code approach offered by Nix and Nixpkgs. You
don't need extra efforts such as setting up DevOps tooling like Docker and
domain specific tools like {renv} to control complex software environments
in R and any other language. It is for example useful for the following
purposes.</p><ol><li><p>test compatibility of custom R code and software/package dependencies in
development and production environments</p></li>
<li><p>directly stream outputs (returned objects), messages and errors from any
command line tool offered in Nixpkgs into an R session.</p></li>
<li><p>Test if evolving R packages change their behavior for given unchanged
R code, and whether they give identical results or not.</p></li>
</ol><p><code>with_nix()</code> can evaluate both R code from a nix-R session within
another nix-R session, and also from a host R session (i.e., on macOS or
Linux) within a specific nix-R session. This feature is useful for testing
the reproducibility and compatibility of given code across different software
environments. If testing of different sets of environments is necessary, you
can easily do so by providing Nix expressions in custom <code>.nix</code> or
<code>default.nix</code> files in different subfolders of the project.</p>
<p><code><a href="rix_init.html">rix_init()</a></code> is run automatically to generate a custom <code>.Rprofile</code>
file for the subshell in <code>project_dir</code>. The defaults in that file ensure
that only R packages from the Nix store, that are defined in the subshell
<code>.nix</code> file are loaded and system's libraries are excluded.</p>
<p>To do its job, <code>with_nix()</code> heavily relies on patterns that manipulate
language expressions (aka computing on the language) offered in base R as
well as the {codetools} package by Luke Tierney.</p>
<p>Some of the key steps that are done behind the scene:</p><ol><li><p>recursively find, classify, and export global objects (globals) in the
call stack of <code>expr</code> as well as propagate R package environments found.</p></li>
<li><p>Serialize (save to disk) and deserialize (read from disk) dependent
data structures as <code>.Rds</code> with necessary function arguments provided,
any relevant globals in the call stack, packages, and <code>expr</code> outputs
returned in a temporary directory.</p></li>
<li><p>Use pure <code>nix-shell</code> environments to execute a R code script
reconstructed catching expressions with quoting; it is launched by commands
like this via <code>{sys}</code> by Jeroen Ooms:
<code>nix-shell --pure --run "Rscript --vanilla"</code>.</p></li>
</ol></div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># create an isolated, runtime-pure R setup via Nix</span></span></span>
<span class="r-in"><span><span class="va">project_path</span> <span class="op">&lt;-</span> <span class="st">"./sub_shell"</span></span></span>
<span class="r-in"><span><span class="fu"><a href="rix_init.html">rix_init</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  project_path <span class="op">=</span> <span class="va">project_path</span>,</span></span>
<span class="r-in"><span>  rprofile_action <span class="op">=</span> <span class="st">"create_missing"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># generate nix environment in `default.nix`</span></span></span>
<span class="r-in"><span><span class="fu"><a href="rix.html">rix</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  r_ver <span class="op">=</span> <span class="st">"4.2.0"</span>,</span></span>
<span class="r-in"><span>  project_path <span class="op">=</span> <span class="va">project_path</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># evaluate function in Nix-R environment via `nix-shell` and `Rscript`,</span></span></span>
<span class="r-in"><span><span class="co"># stream messages, and bring output back to current R session</span></span></span>
<span class="r-in"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">with_nix</span><span class="op">(</span></span></span>
<span class="r-in"><span>  expr <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  program <span class="op">=</span> <span class="st">"R"</span>, project_path <span class="op">=</span> <span class="va">project_path</span>,</span></span>
<span class="r-in"><span>  message_type <span class="op">=</span> <span class="st">"simple"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># There no limit in the complexity of function call stacks that `with_nix()`</span></span></span>
<span class="r-in"><span><span class="co"># can possibly handle; however, `expr` should not evaluate and</span></span></span>
<span class="r-in"><span><span class="co"># needs to be a function for `program = "R"`. If you want to pass the</span></span></span>
<span class="r-in"><span><span class="co"># a function with arguments, you can do like this</span></span></span>
<span class="r-in"><span><span class="va">get_sample</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">seed</span>, <span class="va">n</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>, <span class="va">n</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">with_nix</span><span class="op">(</span></span></span>
<span class="r-in"><span>  expr <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu">get_sample</span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">1234</span>, n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  program <span class="op">=</span> <span class="st">"R"</span>,</span></span>
<span class="r-in"><span>  project_path <span class="op">=</span> <span class="st">"."</span>,</span></span>
<span class="r-in"><span>  message_type <span class="op">=</span> <span class="st">"simple"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## You can also attach packages with `library()` calls in the current R</span></span></span>
<span class="r-in"><span><span class="co">## session, which will be exported to the nix-R session.</span></span></span>
<span class="r-in"><span><span class="co">## Other option: running system commands through `nix-shell` environment.</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Bruno Rodrigues, Philipp Baumann.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer></div>





  </body></html>

