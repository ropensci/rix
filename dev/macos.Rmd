---
title: "2b - Setting up and using rix on macOS"
output: html_document
editor_options:
  chunk_output_type: console
  markdown: 
    wrap: 80
---

*This vignette will discuss macOS-specific topics. If you're not using macOS, you
can ignore this vignette, and read the [Setting up and using rix on Linux and Windows]()
vignette instead.*

## Introduction

When it comes to Nix, there are really only two supported operating systems: macOS
and Linux distributions. Windows is "supported" because it is actually running
Linux thanks to WSL2. In practice this means that Linux distributions and Windows
can be considered one system, and macOS another, separate, system, with its own
idiosyncracies. This vignette details these.

## Installing Nix

You can use `{rix}` to generate Nix expressions even if you don't have Nix installed
on your system, but obviously, you need to install Nix if you actually want to
build the defined development environment and use them. Installing (and uninstalling)
Nix is quite simple, thanks to the installer from
[Determinate
Systems](https://determinate.systems/posts/determinate-nix-installer), a company
that provides services and tools built on Nix. Simply open a terminal and run the following
line:

```{sh, eval=FALSE}
curl --proto '=https' --tlsv1.2 -sSf \
    -L https://install.determinate.systems/nix | \
     sh -s -- install
```

Once you have Nix installed, you can build the expressions you generate with `{rix}`!

## What if you don't have R already installed?

If you have successfully installed Nix, but don't have yet R installed on your
system, you could install R as you would usually do on your operating system,
and then install the `{rix}` package, and from there, generated project-specific
expressions and build them. But you could also install R using Nix. Running the
following line in a terminal will drop you in an interactive R session that you
can use to start generating expressions:

```
nix-shell --expr "$(curl -sl https://raw.githubusercontent.com/b-rodrigues/rix/master/inst/extdata/default.nix)"
```

This should immediately start an R session inside your terminal. You can now run
something like this:

```
rix(r_ver = "latest",
    r_pkgs = c("dplyr", "ggplot2"),
    system_pkgs = NULL,
    git_pkgs = NULL,
    ide = "other",
    project_path = ".",
    overwrite = TRUE)
```

to generate a `default.nix`, and then use that file to generate an environment
with R, `{dplyr}` and `{ggplot2}`. If you need to add packages for your
project, rerun the command above, but add the needed packages to `r_pkgs`.

## Generating expressions

Once you have R installed, either through the usual installer for your operating
system, or through Nix as explained previously, you can now start building
project-specific development environments.

On macOS, generating expressions works just like on Linux and Windows. Start an
R session, and install `{rix}` if that's not already done. Because `{rix}` is
not yet on CRAN, the easiest way is to install it from its r-universe:

```{r, eval=FALSE}
install.packages("rix", repos = c("https://b-rodrigues.r-universe.dev",
  "https://cloud.r-project.org"))
```

You can then use the `{rix}` package to generate expressions. For example, here
is how to generate an expression that installs version 4.2.1 of R and the
`{dplyr}` and `{chronicler}` packages:

```{r, eval=FALSE}
library(rix)

rix(r_ver = "4.2.1",
    r_pkgs = c("dplyr", "chronicler"),
    ide = "other")
```

If you need to install packages from GitHub or other tools, refer to the
vignette [installing R packages in a Nix environment]() to learn how to install
packages from Git or older packages from the CRAN archives, and also refer to
the vignette [installing system tools and TexLive packages in a Nix
environment]() to learn how to add tools other programs to your environment such
as [Quarto](https://quarto.org/) and TexLive packages for writing documents
using the LaTeX typesetting system.

On macOS you might get error messages refering to "shared libraries", which
indicate that your user library of R packages is interfering with the
project-specific Nix environment. In this case, you might want to set up a
project-specific `.Rprofile` using `rix::rix_init()`. This function generates an
`.Rprofile` file on the root of your project and ensures that the Nix
environment only loads R packages from its own project-specific library. This
should solve the issue.

## RStudio and other development interfaces on macOS

As of writing, RStudio cannot be installed through `nixpkgs` for macOS, and if
you wish to use RStudio with a Nix environment, you have to install it through
`nixpkgs`. This means that it is impossible to use RStudio and a Nix environment
on macOS. When you try to generate an expression with `ide =
"rstudio"` on macOS, this will raise a warning. Here are the options you have:

- ignore the warning, because the environment will be built on a Linux
  distribution (even though you generated the expression on macOS) and used on a
  Linux distribution;
- change the `ide =` argument to either `"other"` or `"code"`. Use `"code"` if
  you want to use VS Code and `"other"` for any other editor, like Vim or Emacs.
  These other editors don't need to be installed through `nixpkgs` to use Nix environments,
  unlike RStudio;
- if you're working on a pipeline with the `{targets}` package, you could run it
  on Github Actions. This means you could work on the code on RStudio outside
  of the Nix environment, as the code will only be executed on Github Actions runners. See [this
  vignette](https://b-rodrigues.github.io/rix/articles/reproducible-analytical-pipelines-with-nix.html)
  for further details;
- work on your project as usual, using your usual installation of R and RStudio,
  but generate a `default.nix` at the end with `ide = "other"` with the right
  version of R for reproducibility purposes;
- use subshells to execute only the code you need to run in a specific
  environment. See [this
  vignette](https://b-rodrigues.github.io/rix/articles/running-r-or-shell-code-in-nix-from-r.html);
- help us package RStudio for macOS on `nixpgs`. See
  [https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/editors/rstudio/default.nix](the
  expression for RStudio).


